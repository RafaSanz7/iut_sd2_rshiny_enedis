---
title: "Rapport d'Analyse : DPE 73 & 74"
author: "Rafa√´l Sanz & Quentin Zavagno"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    theme: journal
    df_print: paged

# Param√®tres interactifs du rapport
params:
  departement_choisi:
    label: "D√©partement :"
    value: "Les deux"
    choices: ["73", "74", "Les deux"]
  type_logement_choisi:
    label: "Type de logement :"
    value: "Les deux"
    choices: ["ancien", "neuf", "Les deux"]
---

```{r setup, include=FALSE}

# Options globales pour les chunks
knitr::opts_chunk$set(
  echo = FALSE,     # on n'affiche pas le code dans le rapport
  warning = FALSE,
  message = FALSE,
  fig.width = 10,
  fig.height = 6
)

# Packages utilis√©s dans tout le rapport
library(ggplot2)
library(dplyr)
library(scales)
library(knitr)
library(tidyr)
library(kableExtra)
library(here)

message("Chargement et pr√©paration des donn√©es...")

# Fonction pour charger et pr√©parer les deux fichiers (neufs + existants)
load_report_data <- function() {

  # Import des deux jeux de donn√©es
  df_existants <- read.csv(here("data_dpe_2_savoies_existants.csv"),
                           sep = ";", dec = ".", fileEncoding = "UTF-8")
  df_neufs <- read.csv(here("data_dpe_2_savoies_neufs.csv"),
                       sep = ";", dec = ".", fileEncoding = "UTF-8")

  # Indicateur neuf / ancien
  df_neufs$logement <- "neuf"
  df_existants$logement <- "ancien"

  # On met l‚Äôann√©e courante pour les logements neufs (souvent manquante)
  df_neufs$annee_construction <- as.numeric(format(Sys.Date(), "%Y"))

  # Fusion des colonnes communes
  colonnes <- intersect(names(df_neufs), names(df_existants))
  df <- rbind(df_neufs[, colonnes], df_existants[, colonnes])

  # Extraction du d√©partement depuis le code INSEE
  df$departement <- substr(df$code_insee_ban, 1, 2)
  df$departement[df$departement %in% c("73","74") == FALSE] <- NA

  # Conversion des colonnes num√©riques
  num_cols <- c("cout_chauffage", "cout_ecs", "cout_total_5_usages",
                "emission_ges_5_usages", "surface_habitable_logement")

  df[num_cols] <- lapply(df[num_cols], function(x) {
    as.numeric(gsub(" ", "", x))
  })

  # Construction de la variable p√©riode
  df$periode_construction <- cut(
    df$annee_construction,
    breaks = c(0,1960,1970,1980,1990,2000,2010,2050),
    labels = c("Avant 1960","1961 - 1970","1971 - 1980",
               "1981 - 1990","1991 - 2000","2001 - 2010","Apr√®s 2010"),
    right = FALSE
  )

  # Mise en ordre des classes DPE
  dpe_levels <- c("A","B","C","D","E","F","G")
  df$etiquette_dpe <- factor(df$etiquette_dpe, levels = dpe_levels, ordered = TRUE)

  # Nettoyage final
  df <- df %>%
    filter(!is.na(departement),
           !is.na(logement),
           !is.na(etiquette_dpe),
           !is.na(cout_total_5_usages),
           !is.na(emission_ges_5_usages))

  return(df)
}

# Chargement des donn√©es compl√®tes
data_full <- load_report_data()

# Application des filtres choisis dans les param√®tres
data_filtree <- data_full

if (params$departement_choisi != "Les deux") {
  data_filtree <- filter(data_filtree, departement == params$departement_choisi)
}

if (params$type_logement_choisi != "Les deux") {
  data_filtree <- filter(data_filtree, logement == params$type_logement_choisi)
}

# Th√®me graphique utilis√© dans tous les graphes
theme_rapport <- theme_minimal(base_size = 14) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))

# Couleurs officielles du DPE
colors_dpe <- c(
  A = "#00B050", B = "#92D050", C = "#FFFF00",
  D = "#FFC000", E = "#FF9900", F = "#FF0000", G = "#C00000"
)
```

# Introduction 

Dans le cadre du d√©fi lanc√© par **Enedis** autour de l‚Äô√©valuation de l‚Äôimpact du Diagnostic de Performance √ânerg√©tique (DPE) sur les consommations des logements, la soci√©t√© **GreenTech Solutions** nous a confi√© la r√©alisation d‚Äôune √©tude statistique et d‚Äôune application interactive RShiny.

Le pr√©sent rapport constitue le premier livrable attendu : une analyse claire et structur√©e des performances √©nerg√©tiques des logements situ√©s en **Savoie (73)** et en **Haute-Savoie (74)**.  

Cette √©tude se concentre sur les donn√©es publiques issues des DPE ¬´ logements neufs ¬ª et ¬´ logements existants ¬ª, enrichies par la Base Adresse Nationale.

L‚Äôobjectif est double :

- **d√©crire et comparer les profils √©nerg√©tiques** des deux d√©partements ;  
- **identifier les facteurs influen√ßant les co√ªts √©nerg√©tiques**, notamment l‚Äô√©tiquette DPE, la p√©riode de construction et la surface habitable.

Pour r√©pondre √† ces objectifs, le rapport s'appuie sur :

- des **KPI essentiels** (co√ªts, GES, surfaces, r√©partition des classes DPE) ;  
- des **visualisations vari√©es** : histogrammes, diagrammes en barres, nuages de points, graphiques comparatifs 73/74 ;  
- des **statistiques bivari√©es**, dont la corr√©lation entre surface et co√ªt de chauffage ;  
- des analyses dynamiques bas√©es sur les **filtres d√©finis par l‚Äôutilisateur** : d√©partement, code postal et type de logement (ancien, neuf ou les deux).

Les r√©sultats qui suivent mettent en lumi√®re les tendances g√©n√©rales du territoire, ainsi que les sp√©cificit√©s locales de chaque d√©partement.


**Param√®tres :**

- D√©partement : `r params$departement_choisi`  
- Type de logement : `r params$type_logement_choisi`  

---

# üîë Indicateurs cl√©s 

```{r indicateurs}
# Quelques indicateurs simples pour r√©sumer le jeu filtr√©

kpi_logements <- prettyNum(nrow(data_filtree), big.mark = " ")

kpi_cout_moyen <- paste0(
  format(round(mean(data_filtree$cout_total_5_usages), 0), big.mark = " "), " ‚Ç¨"
)

kpi_ges_total <- paste0(
  format(round(mean(data_filtree$emission_ges_5_usages), 0), big.mark = " "), " kgCO‚ÇÇ/an"
)

kpi_ges_moyen <- paste0(
  round(mean(data_filtree$emission_ges_5_usages /
               data_filtree$surface_habitable_logement, na.rm=TRUE), 2),
  " kgCO‚ÇÇ/m¬≤/an"
)

kpi_surface_moyenne <- paste0(
  round(mean(data_filtree$surface_habitable_logement), 1), " m¬≤"
)

kpi_df <- data.frame(
  Indicateur = c("Nombre total de logements",
                 "Co√ªt annuel moyen (5 usages)",
                 "GES total moyen",
                 "GES moyen par m¬≤",
                 "Surface habitable moyenne"),
  Valeur = c(kpi_logements, kpi_cout_moyen, kpi_ges_total,
             kpi_ges_moyen, kpi_surface_moyenne)
)

kable(kpi_df, "html") %>% 
  kable_styling(bootstrap_options = c("striped","hover"))
```

# üí∏ R√©partition des co√ªts √©nerg√©tiques


```{r part-usages}
df2 <- data_filtree %>%
  mutate(
    cout_ecs_pct = cout_ecs / cout_total_5_usages * 100,
    cout_chauffage_pct = cout_chauffage / cout_total_5_usages * 100,
    cout_refroidissement_pct = cout_refroidissement / cout_total_5_usages * 100,
    cout_eclairage_pct = cout_eclairage / cout_total_5_usages * 100,
    cout_auxiliaires_pct = cout_auxiliaires / cout_total_5_usages * 100,
    ges_chauffage_pct = emission_ges_chauffage / emission_ges_5_usages * 100,
    ges_ecs_pct = emission_ges_ecs / emission_ges_5_usages * 100
  )

```

## Tableau des co√ªts 


```{r tableau-couts, results='asis'}
table_couts <- df2 %>%
  group_by(departement) %>%
  summarise(
    Chauffage = mean(cout_chauffage_pct, na.rm = TRUE),
    ECS = mean(cout_ecs_pct, na.rm = TRUE),
    Refroidissement = mean(cout_refroidissement_pct, na.rm = TRUE),
    √âclairage = mean(cout_eclairage_pct, na.rm = TRUE),
    Auxiliaires = mean(cout_auxiliaires_pct, na.rm = TRUE),
    .groups = "drop"
  )

kable(table_couts, "html", digits = 1, caption = "Part moyenne des co√ªts par usage (%)") %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover"))
```

# üåç R√©partition des √©missions GES

```{r tableau-ges}
table_ges <- df2 %>%
  mutate(
    ges_chauffage_pct = pmin(ges_chauffage_pct,100),
    ges_ecs_pct = pmin(ges_ecs_pct,100)
  ) %>%
  group_by(departement) %>%
  summarise(
    GES_total = paste0(round(mean(emission_ges_5_usages),1)," kgCO‚ÇÇ/an"),
    GES_chauffage_pct = paste0(round(mean(ges_chauffage_pct),1)," %"),
    GES_ECS_pct = paste0(round(mean(ges_ecs_pct),1)," %")
  )

kable(table_ges, "html") %>%
  kable_styling(full_width = FALSE)

```

# üè∑Ô∏è R√©partition des √âtiquettes DPE

```{r repartition-dpe, fig.height=5}

# Si plusieurs d√©partements pr√©sents -> comparaison
if (length(unique(data_filtree$departement)) > 1) {

  df_plot_dpe <- data_filtree %>%
    count(departement, etiquette_dpe) %>%
    group_by(departement) %>%
    mutate(pourcentage = n / sum(n),
           etiquette_dpe = factor(etiquette_dpe,
                                  levels = c("A","B","C","D","E","F","G"),
                                  ordered = TRUE))

  ggplot(df_plot_dpe, aes(x = etiquette_dpe, y = pourcentage,
                          fill = etiquette_dpe)) +
    geom_col(position = "dodge", width = 0.7) +
    geom_text(aes(label = paste0(round(pourcentage*100,1),"%"),
                  group = departement),
              position = position_dodge(width = 0.7),
              vjust = -0.5, size = 3.8) +
    scale_y_continuous(labels = scales::percent_format()) +
    scale_fill_manual(values = colors_dpe, drop = FALSE) +
    facet_wrap(~ departement, nrow = 1) +
    labs(
      title = "R√©partition des √âtiquettes DPE par d√©partement",
      x = "√âtiquette DPE", y = "Proportion (%)"
    ) +
    theme_rapport

} else {

  # Cas simple : 1 seul d√©partement ou filtrage CP
  df_plot_dpe <- data_filtree %>%
    count(etiquette_dpe) %>%
    mutate(
      pourcentage = n / sum(n),
      etiquette_dpe = factor(etiquette_dpe,
                             levels = c("A","B","C","D","E","F","G"),
                             ordered = TRUE)
    )

  ggplot(df_plot_dpe, aes(x = etiquette_dpe, y = pourcentage, fill = etiquette_dpe)) +
    geom_col(width = 0.7) +
    geom_text(aes(label = paste0(round(pourcentage*100,1),"%")), 
              vjust = -0.4, size = 4) +
    scale_y_continuous(labels = scales::percent_format()) +
    scale_fill_manual(values = colors_dpe, drop = FALSE) +
    labs(
      title = "R√©partition des √âtiquettes DPE",
      x = "√âtiquette DPE", y = "Proportion (%)"
    ) +
    theme_rapport
}

```

# üí∂ Co√ªt annuel moyen par √©tiquette
```{r cout-moyen-dpe, fig.height=5}

# Si plusieurs d√©partements pr√©sents ‚Üí comparatif 73 vs 74
if (length(unique(data_filtree$departement)) > 1) {

  data_bar <- data_filtree %>%
    filter(cout_total_5_usages < quantile(cout_total_5_usages, 0.99, na.rm = TRUE)) %>%
    group_by(departement, etiquette_dpe) %>%
    summarise(
      cout_moyen = mean(cout_total_5_usages, na.rm = TRUE),
      .groups = "drop"
    ) %>%
    mutate(
      etiquette_dpe = factor(etiquette_dpe,
                             levels = c("A","B","C","D","E","F","G"),
                             ordered = TRUE)
    )

  ggplot(data_bar, aes(x = etiquette_dpe, y = cout_moyen, fill = etiquette_dpe)) +
    geom_col(position = position_dodge(width = 0.7), width = 0.7) +
    geom_text(aes(label = paste0(format(round(cout_moyen, 0), big.mark = " "), " ‚Ç¨"),
                  group = departement),
              position = position_dodge(width = 0.7),
              vjust = -0.4, size = 3.5) +
    scale_y_continuous(labels = scales::comma_format(suffix = " ‚Ç¨", big.mark = " "),
                       expand = expansion(mult = c(0, 0.15))) +
    scale_fill_manual(values = colors_dpe, drop = FALSE) +
    facet_wrap(~ departement, nrow = 1) +
    labs(
      title = "Co√ªt annuel moyen (5 usages) par √©tiquette DPE",
      x = "√âtiquette DPE",
      y = "Co√ªt annuel moyen (‚Ç¨)"
    ) +
    theme_rapport

} else {

  # Cas simple : un seul d√©partement ou filtrage CP
  data_bar <- data_filtree %>%
    filter(cout_total_5_usages < quantile(cout_total_5_usages, 0.99, na.rm = TRUE)) %>%
    group_by(etiquette_dpe) %>%
    summarise(
      cout_moyen = mean(cout_total_5_usages, na.rm = TRUE),
      .groups = "drop"
    ) %>%
    mutate(
      etiquette_dpe = factor(etiquette_dpe,
                             levels = c("A","B","C","D","E","F","G"),
                             ordered = TRUE)
    )

  ggplot(data_bar, aes(x = etiquette_dpe, y = cout_moyen, fill = etiquette_dpe)) +
    geom_col(width = 0.7) +
    geom_text(aes(label = paste0(format(round(cout_moyen, 0), big.mark = " "), " ‚Ç¨")),
              vjust = -0.4, size = 4) +
    scale_y_continuous(labels = scales::comma_format(suffix = " ‚Ç¨", big.mark = " "),
                       expand = expansion(mult = c(0, 0.15))) +
    scale_fill_manual(values = colors_dpe, drop = FALSE) +
    labs(
      title = "Co√ªt annuel moyen (5 usages) par √©tiquette DPE",
      x = "√âtiquette DPE",
      y = "Co√ªt annuel moyen (‚Ç¨)"
    ) +
    theme_rapport
}

```



# üß± R√©partition par p√©riode de construction

```{r repartition-periode, fig.height=5}

df_plot_periode <- data_filtree %>%
  filter(!is.na(periode_construction)) %>%     # << suppression NA
  count(periode_construction) %>%
  mutate(
    pourcentage = n / sum(n),
    periode_construction = factor(
      periode_construction,
      levels = unique(periode_construction)    # garde ton ordre d‚Äôorigine
    )
  )

ggplot(df_plot_periode,
       aes(x = periode_construction,
           y = pourcentage,
           fill = periode_construction)) +
  geom_col(width = 0.7) +
  geom_text(aes(label = paste0(round(pourcentage*100,1),"%")),
            vjust = -0.3, size = 3.5) +
  scale_y_continuous(labels = scales::percent_format()) +
  scale_fill_brewer(palette = "Set3") +
  labs(
    title = "R√©partition par P√©riode de Construction",
    x = "P√©riode de construction",
    y = "Proportion (%)"
  ) +
  theme_rapport +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

### Tableau de r√©partion des logements du 73 et 74 en fonction de la p√©riode de construction

```{r tableau-periodes, results='asis'}
# On retire les NA (comme pour le graphique)
df_tab <- data_filtree %>%
  filter(!is.na(periode_construction)) %>% 
  mutate(
    periode_construction = factor(
      periode_construction,
      levels = c("Avant 1960","1961 - 1970","1971 - 1980",
                 "1981 - 1990","1991 - 2000","2001 - 2010","Apr√®s 2010"),
      ordered = TRUE
    )
  )

# ----- Cas comparatif -----
if (length(unique(df_tab$departement)) > 1) {

  table_periode <- df_tab %>%
    count(departement, periode_construction) %>%
    group_by(departement) %>%
    mutate(pct = round(n / sum(n) * 100, 1)) %>%
    ungroup() %>%
    tidyr::pivot_wider(
      names_from = departement,
      values_from = c(n, pct),
      values_fill = 0
    ) %>%
    arrange(periode_construction)   # <-- ordre correct

  kable(table_periode, "html") %>%
    kable_styling(
      full_width = FALSE,
      bootstrap_options = c("striped", "hover", "condensed")
    )

# ----- Cas simple -----
} else {

  table_periode <- df_tab %>%
    count(periode_construction) %>%
    mutate(pct = round(n / sum(n) * 100, 1)) %>%
    arrange(periode_construction)

  kable(table_periode, "html") %>%
    kable_styling(
      full_width = FALSE,
      bootstrap_options = c("striped", "hover", "condensed")
    )
}


```


# üìà Corr√©lation Surface / Co√ªt Chauffage

```{r corr}
df_correl <- data_filtree %>%
  filter(!is.na(surface_habitable_logement),
         !is.na(cout_chauffage),
         surface_habitable_logement < 500,
         cout_chauffage < 10000)

correlation <- cor(df_correl$surface_habitable_logement,
                   df_correl$cout_chauffage,
                   use="complete.obs")

ggplot(df_correl, aes(surface_habitable_logement, cout_chauffage)) +
  geom_point(alpha = 0.15, color="steelblue") +
  geom_smooth(method="lm", se=TRUE, color="red") +
  labs(
    title = "Corr√©lation entre la surface et le co√ªt du chauffage",
    subtitle = paste("Corr√©lation de Pearson :", round(correlation,3)),
    x = "Surface habitable (m¬≤)",
    y = "Co√ªt du chauffage (‚Ç¨)"
  ) +
  theme_rapport
```

---

# Conclusion

Cette analyse met en √©vidence plusieurs enseignements cl√©s concernant la performance √©nerg√©tique des logements √©tudi√©s.

**1. R√©partition des DPE**  
Les √©tiquettes *C, D* et *E* regroupent la majorit√© des logements, tandis que les DPE *F* et *G* ‚Äî plus √©nergivores ‚Äî restent significativement minoritaires, mais pr√©sentent des co√ªts nettement sup√©rieurs.  
Cela confirme que la performance √©nerg√©tique exerce un impact direct sur le niveau de d√©penses annuelles.

**2. Diff√©rences entre Savoie et Haute-Savoie**  
Lorsque les deux d√©partements sont analys√©s conjointement, des √©carts apparaissent :
- La **Haute-Savoie (74)** concentre proportionnellement davantage de logements r√©cents (p√©riode *Apr√®s 2010*).  
- La **Savoie (73)** pr√©sente une part l√©g√®rement plus √©lev√©e de b√¢timents anciens (*Avant 1960*).

Ces diff√©rences structurelles influencent partiellement les niveaux de consommation et les profils √©nerg√©tiques observ√©s.

**3. Co√ªts √©nerg√©tiques**  
Le co√ªt annuel moyen suit une progression claire selon les √©tiquettes DPE :  
‚Üí Les logements F et G se distinguent par des co√ªts beaucoup plus √©lev√©s que les classes A √† D, refl√©tant une moindre efficacit√© √©nerg√©tique.

**4. Corr√©lation surface ‚Äì co√ªt chauffage**  
L‚Äôanalyse met en √©vidence une relation positive entre la surface habitable et le co√ªt du chauffage.  
Le coefficient de corr√©lation de Pearson est : **`r round(correlation, 3)`**.  
Cela traduit une **corr√©lation mod√©r√©e**, logique : les logements plus grands tendent √† g√©n√©rer des d√©penses plus √©lev√©es, tout en restant sensibles √† la qualit√© de l'isolation et au type d‚Äô√©nergie utilis√©e.

---

**En synth√®se**, ce rapport confirme l‚Äôimportance des caract√©ristiques structurelles (p√©riode de construction, surface, typologie des logements) et de l‚Äô√©tiquette DPE dans l‚Äôexplication des performances √©nerg√©tiques observ√©es.

Rapport g√©n√©r√© automatiquement √† partir des donn√©es filtr√©es.
