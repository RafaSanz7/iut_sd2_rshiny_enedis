---
title: "Rapport d'Analyse : DPE 73 & 74"
author: "Rafaël Sanz & Quentin Zavagno"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    theme: journal
    df_print: paged
params:
  departement_choisi:
    label: "Département :"
    value: "Les deux"
    choices: ["73", "74", "Les deux"]
  type_logement_choisi:
    label: "Type de logement :"
    value: "Les deux"
    choices: ["ancien", "neuf", "Les deux"]
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  fig.width = 10,
  fig.height = 6,
  dev = "png"
)

library(ggplot2)
library(dplyr)
library(scales)
library(knitr)
library(kableExtra)
library(here)

message("Chargement et préparation des données...")

load_report_data <- function() {
  df_existants <- read.csv(here("data_dpe_2_savoies_existants.csv"),
                           header = TRUE, sep = ";", dec = ".", fileEncoding = "UTF-8")

  df_neufs <- read.csv(here("data_dpe_2_savoies_neufs.csv"),
                       header = TRUE, sep = ";", dec = ".", fileEncoding = "UTF-8")

  df_neufs$logement <- "neuf"
  df_neufs$annee_construction <- as.numeric(format(Sys.Date(), "%Y"))
  df_existants$logement <- "ancien"

  colonnes_communes <- intersect(colnames(df_neufs), colnames(df_existants))
  df <- rbind(df_neufs[, colonnes_communes],
              df_existants[, colonnes_communes])

  df$departement <- ifelse(substr(df$code_insee_ban, 1, 2) == "73", "73",
                           ifelse(substr(df$code_insee_ban, 1, 2) == "74", "74", NA))

  numeric_cols <- c("cout_chauffage", "cout_ecs", "cout_total_5_usages",
                    "emission_ges_5_usages", "surface_habitable_logement")

  df[, numeric_cols] <- lapply(df[, numeric_cols],
                               function(x) as.numeric(gsub(" ", "", x)))

  df$periode_construction <- cut(df$annee_construction,
                                 breaks = c(0,1960,1970,1980,1990,2000,2010,2050),
                                 labels = c("Avant 1960", "1961 - 1970", "1971 - 1980",
                                            "1981 - 1990", "1991 - 2000",
                                            "2001 - 2010", "Après 2010"),
                                 right = FALSE)

  dpe_levels <- c("A","B","C","D","E","F","G")
  df$etiquette_dpe <- factor(df$etiquette_dpe, levels = dpe_levels, ordered = TRUE)

  df <- df %>%
    filter(!is.na(departement),
           !is.na(logement),
           !is.na(etiquette_dpe),
           !is.na(cout_total_5_usages),
           !is.na(emission_ges_5_usages))

  return(df)
}

data_full <- load_report_data()

data_filtree <- data_full

if (params$departement_choisi != "Les deux") {
  data_filtree <- data_filtree %>% filter(departement == params$departement_choisi)
}

if (params$type_logement_choisi != "Les deux") {
  data_filtree <- data_filtree %>% filter(logement == params$type_logement_choisi)
}

theme_rapport <- theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    legend.position = "none"
  )

colors_dpe <- c(
  A = "#00B050", B = "#92D050", C = "#FFFF00",
  D = "#FFC000", E = "#FF9900", F = "#FF0000", G = "#C00000"
)
```

# Introduction et Indicateurs Clés

Ce rapport présente une analyse des Diagnostics de Performance Énergétique (DPE) pour les logements des départements de la Savoie (73) et de la Haute-Savoie (74).

**Paramètres :**

- Département : `r params$departement_choisi`  
- Type de logement : `r params$type_logement_choisi`  

---

# Indicateurs clés

```{r indicateurs}
# === KPI : Nombre de logements ===
kpi_logements <- prettyNum(nrow(data_filtree), big.mark = " ")

# === KPI : Coût annuel moyen ===
kpi_cout_moyen <- paste0(
  format(
    round(mean(data_filtree$cout_total_5_usages, na.rm = TRUE), 0),
    big.mark = " "
  ),
  " €"
)

# === KPI : GES total moyen (kgCO₂/an) ===
kpi_ges_total <- paste0(
  format(
    round(mean(data_filtree$emission_ges_5_usages, na.rm = TRUE), 0),
    big.mark = " "
  ),
  " kgCO₂/an"
)

# === KPI : GES moyen par m² (kgCO₂/m²/an) ===
kpi_ges_moyen <- paste0(
  round(
    mean(data_filtree$emission_ges_5_usages / data_filtree$surface_habitable_logement,
         na.rm = TRUE), 2
  ),
  " kgCO₂/m²/an"
)

# === KPI : Surface moyenne ===
kpi_surface_moyenne <- paste0(
  round(mean(data_filtree$surface_habitable_logement, na.rm = TRUE), 1),
  " m²"
)

# === Tableau KPI ===
kpi_df <- data.frame(
  Indicateur = c(
    "Nombre total de logements",
    "Coût annuel moyen (5 usages)",
    "GES total moyen",
    "GES moyen par m²",
    "Surface habitable moyenne"
  ),
  Valeur = c(
    kpi_logements,
    kpi_cout_moyen,
    kpi_ges_total,
    kpi_ges_moyen,
    kpi_surface_moyenne
  ),
  stringsAsFactors = FALSE
)

kable(kpi_df, "html") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = FALSE)
```

```{r part-usages}
df2 <- data_filtree

df2 <- df2 %>%
  mutate(
    cout_ecs_pct = round(cout_ecs / cout_total_5_usages * 100, 2),
    cout_chauffage_pct = round(cout_chauffage / cout_total_5_usages * 100, 2),
    cout_refroidissement_pct = round(cout_refroidissement / cout_total_5_usages * 100, 2),
    cout_eclairage_pct = round(cout_eclairage / cout_total_5_usages * 100, 2),
    cout_auxiliaires_pct = round(cout_auxiliaires / cout_total_5_usages * 100, 2),
    ges_chauffage_pct = round(emission_ges_chauffage / emission_ges_5_usages * 100, 2),
    ges_ecs_pct = round(emission_ges_ecs / emission_ges_5_usages * 100, 2)
  )
```

## Répartition des coûts énergétiques

```{r tableau-couts, results='asis'}
table_couts <- df2 %>%
  group_by(departement) %>%
  summarise(
    Chauffage = mean(cout_chauffage_pct, na.rm = TRUE),
    ECS = mean(cout_ecs_pct, na.rm = TRUE),
    Refroidissement = mean(cout_refroidissement_pct, na.rm = TRUE),
    Éclairage = mean(cout_eclairage_pct, na.rm = TRUE),
    Auxiliaires = mean(cout_auxiliaires_pct, na.rm = TRUE),
    .groups = "drop"
  )

kable(table_couts, "html", digits = 1, caption = "Part moyenne des coûts par usage (%)") %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover"))
```

## Répartition des émissions de GES

```{r tableau-ges, results='asis'}
# === TABLEAU GES CORRIGÉ ===

# On calcule les % et le total
table_ges <- df2 %>%
  summarise(
    departement = departement,
    GES_total = emission_ges_5_usages,
    GES_chauffage_pct = ges_chauffage_pct,
    GES_ECS_pct = ges_ecs_pct
  )

# Correction des pourcentages impossibles (>100 %)
table_ges <- table_ges %>%
  mutate(
    GES_chauffage_pct = pmin(GES_chauffage_pct, 100),
    GES_ECS_pct = pmin(GES_ECS_pct, 100)
  )

# Agrégation par département
table_ges <- table_ges %>%
  group_by(departement) %>%
  summarise(
    GES_total = round(mean(GES_total, na.rm = TRUE), 1),
    GES_chauffage_pct = round(mean(GES_chauffage_pct, na.rm = TRUE), 1),
    GES_ECS_pct = round(mean(GES_ECS_pct, na.rm = TRUE), 1),
    .groups = "drop"
  ) %>%
  
  # Ajout des unités nécessaires
  mutate(
    GES_total = paste0(format(GES_total, big.mark = " "), " kgCO₂/an"),
    GES_chauffage_pct = paste0(GES_chauffage_pct, " %"),
    GES_ECS_pct = paste0(GES_ECS_pct, " %")
  )

# Affichage avec kable
kable(
  table_ges,
  "html",
  caption = "GES total et répartition (%) par département"
) %>%
  kable_styling(
    full_width = FALSE,
    bootstrap_options = c("striped", "hover", "condensed")
  )
```

---

# Répartition des Étiquettes DPE

```{r repartition-dpe, fig.height=5}

# Si plusieurs départements présents -> comparaison
if (length(unique(data_filtree$departement)) > 1) {

  df_plot_dpe <- data_filtree %>%
    count(departement, etiquette_dpe) %>%
    group_by(departement) %>%
    mutate(pourcentage = n / sum(n),
           etiquette_dpe = factor(etiquette_dpe,
                                  levels = c("A","B","C","D","E","F","G"),
                                  ordered = TRUE))

  ggplot(df_plot_dpe, aes(x = etiquette_dpe, y = pourcentage,
                          fill = etiquette_dpe)) +
    geom_col(position = "dodge", width = 0.7) +
    geom_text(aes(label = paste0(round(pourcentage*100,1),"%"),
                  group = departement),
              position = position_dodge(width = 0.7),
              vjust = -0.5, size = 3.8) +
    scale_y_continuous(labels = scales::percent_format()) +
    scale_fill_manual(values = colors_dpe, drop = FALSE) +
    facet_wrap(~ departement, nrow = 1) +
    labs(
      title = "Répartition des Étiquettes DPE par département",
      x = "Étiquette DPE", y = "Proportion (%)"
    ) +
    theme_rapport

} else {

  # Cas simple : 1 seul département ou filtrage CP
  df_plot_dpe <- data_filtree %>%
    count(etiquette_dpe) %>%
    mutate(
      pourcentage = n / sum(n),
      etiquette_dpe = factor(etiquette_dpe,
                             levels = c("A","B","C","D","E","F","G"),
                             ordered = TRUE)
    )

  ggplot(df_plot_dpe, aes(x = etiquette_dpe, y = pourcentage, fill = etiquette_dpe)) +
    geom_col(width = 0.7) +
    geom_text(aes(label = paste0(round(pourcentage*100,1),"%")), 
              vjust = -0.4, size = 4) +
    scale_y_continuous(labels = scales::percent_format()) +
    scale_fill_manual(values = colors_dpe, drop = FALSE) +
    labs(
      title = "Répartition des Étiquettes DPE",
      x = "Étiquette DPE", y = "Proportion (%)"
    ) +
    theme_rapport
}

```

---

# Répartition par Période de Construction

```{r}
df_plot_periode <- data_filtree %>%
  count(periode_construction) %>%
  mutate(pourcentage = n / sum(n))

ggplot(df_plot_periode, aes(periode_construction, pourcentage, fill = periode_construction)) +
  geom_bar(stat="identity") +
  geom_text(aes(label = percent(pourcentage, accuracy = 0.1)),
            vjust = -0.3, size = 3.5) +
  scale_y_continuous(labels = percent_format()) +
  theme_rapport +
  ggtitle("Répartition par Période de Construction") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

---

# Coût Total par Étiquette DPE

```{r cout-moyen-dpe}
data_bar <- data_filtree %>%
  filter(cout_total_5_usages < quantile(cout_total_5_usages, 0.99, na.rm = TRUE)) %>%
  group_by(etiquette_dpe) %>%
  summarise(
    cout_moyen = mean(cout_total_5_usages, na.rm = TRUE),
    .groups = "drop"
  )

ggplot(data_bar, aes(x = etiquette_dpe, y = cout_moyen, fill = etiquette_dpe)) +
  geom_col() +
  scale_y_continuous(labels = dollar_format(suffix = " €", prefix = "")) +
  scale_fill_manual(values = c(
    "A"="#00B050","B"="#92D050","C"="#FFFF00",
    "D"="#FFC000","E"="#FF9900",
    "F"="#FF0000","G"="#C00000"
  )) +
  theme_rapport +
  ggtitle("Coût Total moyen (5 usages) par Étiquette DPE") +
  xlab("Étiquette DPE") +
  ylab("Coût annuel moyen (5 usages)")
```


---

# Corrélation Surface / Coût Chauffage

```{r}
df_correl <- data_filtree %>%
  filter(!is.na(surface_habitable_logement),
         !is.na(cout_chauffage),
         surface_habitable_logement < 500,
         cout_chauffage < 10000)

df_plot_correl <- if (nrow(df_correl) > 10000) sample_n(df_correl, 10000) else df_correl

correlation <- cor(df_correl$surface_habitable_logement, df_correl$cout_chauffage)

ggplot(df_plot_correl, aes(surface_habitable_logement, cout_chauffage)) +
  geom_point(alpha = 0.2, color="blue") +
  geom_smooth(method="lm", color="red", se=TRUE) +
  labs(
    x = "Surface Habitable (m²)",
    y = "Coût Chauffage (€)",
    title = "Corrélation entre la Surface Habitable et le Coût du Chauffage",
    subtitle = paste("Coefficient de corrélation (Pearson) :", round(correlation, 3))
  ) +
  scale_y_continuous(labels = dollar_format(suffix=" €", prefix="")) +
  theme_rapport
```

---

# Conclusion

L’analyse confirme :

- Les logements F et G ont des coûts énergétiques beaucoup plus élevés.
- La surface habitable est fortement corrélée au coût du chauffage : `r round(correlation, 3)`.

Rapport généré automatiquement.
